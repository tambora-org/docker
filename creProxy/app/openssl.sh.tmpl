#!/bin/sh 
{{ if (not (exists "/etc/letsencrypt/live/dhparam.pem")) }}
if ! [ -e /etc/letsencrypt/live/dhparam.pem ]
then
   openssl dhparam -out /etc/letsencrypt/live/dhparam.pem 4096
fi
{{ end }}


{{ $CurrentContainer := where $ "ID" .Docker.CurrentContainerID | first }}
{{ $CurrentDomain := or $CurrentContainer.Env.CRE_DOMAIN "localhost" }}

openssl req -batch -config openssl.cfg -new -x509 -sha256 -newkey rsa:2048 -nodes -keyout /etc/letsencrypt/live/{{ $CurrentDomain }}.key.pem -days 365 -out /etc/letsencrypt/live/{{ $CurrentDomain }}.cert.pem

{{ range $subdomain, $containers := groupByMulti $ "Env.CRE_SUBDOMAIN" "," }}

{{ $subdomain := trim $subdomain }}
{{ $host := (printf "%s.%s" $subdomain $CurrentDomain) }}

# {{ $host }}
# for localhost create openssl sel-signed
openssl req -batch -config openssl.cfg -new -x509 -sha256 -newkey rsa:2048 -nodes -keyout /etc/letsencrypt/live/{{ $host }}.key.pem -days 365 -out /etc/letsencrypt/live/{{ $host }}.cert.pem

certbot --noninteractive --nginx --agree-tos -m mail@{{ $CurrentDomain }} --domains {{ $host }}

{{ end }}

# Finally reload nginx
#nginx -s reload